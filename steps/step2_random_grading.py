def run_step2():
    st.subheader("ğŸ“„ STEP 2: í•™ìƒ ë‹µì•ˆ ì—…ë¡œë“œ ë° ì²« ë²ˆì§¸ ë‹µì•ˆ ì±„ì ")

    # STEP 1ì—ì„œ ìƒì„±ëœ ë¬¸ì œì™€ íŒŒì¼ëª…ì´ ìˆì–´ì•¼ ì§„í–‰ ê°€ëŠ¥
    if st.session_state.get("problem_text") and st.session_state.get("problem_filename"):
        rubric_key = f"rubric_{st.session_state.problem_filename}"
        rubric = st.session_state.generated_rubrics.get(rubric_key)

        if rubric:
            st.markdown("#### ğŸ“Š ì±„ì  ê¸°ì¤€")
            st.markdown(rubric)

        # í•™ìƒ PDF ì—…ë¡œë“œ UI
        student_pdfs = st.file_uploader(
            "ğŸ“¥ ì±„ì  ê¸°ì¤€ í…ŒìŠ¤íŠ¸ íŒŒì¼ ì—…ë¡œë“œ",
            type="pdf",
            accept_multiple_files=True,
            key="student_pdfs_upload"
        )

        # 'ì„ì‹œ ì±„ì ' ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì²« ë²ˆì§¸ PDFë§Œ ì±„ì 
        if student_pdfs and st.button("ì„ì‹œ ì±„ì "):
            selected_file = student_pdfs[0]
            # 1) ì—…ë¡œë“œëœ íŒŒì¼ì„ ì„ì‹œ ë””ìŠ¤í¬ì— ì €ì¥
            uploaded_path, safe_name = save_uploaded_file(selected_file)
            # 2) íŒŒì¼ëª…ì—ì„œ í•™ìƒ ì´ë¦„, í•™ë²ˆ ì¶”ì¶œ
            name, sid = extract_info_from_filename(selected_file.name)

            # 3) í…ìŠ¤íŠ¸ ì¶”ì¶œ
            with st.spinner("í•™ìƒ ë‹µì•ˆì„ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤..."):
                text = extract_text_from_pdf(uploaded_path)
                text = clean_text_postprocess(text)

            # 4) ì„ì‹œíŒŒì¼ ì‚­ì œ
            try:
                os.unlink(uploaded_path)
            except:
                pass

            # 5) ì¶”ì¶œëœ í…ìŠ¤íŠ¸ê°€ ì—†ìœ¼ë©´ ê²½ê³ 
            if not text.strip():
                st.warning("âš ï¸ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")
                return

            # 6) GPT ì±„ì  í”„ë¡¬í”„íŠ¸ ìƒì„±
            prompt = f"""ë‹¹ì‹ ì€ ëŒ€í•™ ì‹œí—˜ì„ ì±„ì í•˜ëŠ” GPT ì±„ì ìì…ë‹ˆë‹¤.

ë‹¹ì‹ ì˜ ì—­í• ì€, ì‚¬ëŒì´ ì‘ì„±í•œ "ì±„ì  ê¸°ì¤€"ì— **ì—„ê²©í•˜ê²Œ ë”°ë¼** í•™ìƒì˜ ë‹µì•ˆì„ ì±„ì í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.  
**ì°½ì˜ì ì¸ í•´ì„ì´ë‚˜ ê¸°ì¤€ ë³€ê²½ ì—†ì´**, ê° í•­ëª©ì— ëŒ€í•´ **ì •í™•í•œ ê·¼ê±°ì™€ í•¨ê»˜ ì ìˆ˜ë¥¼ ë¶€ì—¬**í•´ì•¼ í•©ë‹ˆë‹¤.

ì•„ë˜ëŠ” êµìˆ˜ìê°€ ë§Œë“  ì±„ì  ê¸°ì¤€ì…ë‹ˆë‹¤:
{rubric}

ë‹¤ìŒì€ í•™ìƒ ë‹µì•ˆì…ë‹ˆë‹¤:
{text}

ğŸ“Œ ì±„ì  ì¶œë ¥ í˜•ì‹
ë‹¤ìŒ í˜•ì‹ì˜ ë§ˆí¬ë‹¤ìš´ í‘œë¥¼ ì‘ì„±í•˜ì„¸ìš”:

| ì±„ì  í•­ëª© | ë°°ì  | ë¶€ì—¬ ì ìˆ˜ | í‰ê°€ ê·¼ê±° |
|---|---|---|---|
| ì˜ˆ: í•µì‹¬ ê°œë… ì„¤ëª… | 3ì  | 2ì  | "í•µì‹¬ ê°œë…ì„ ì–¸ê¸‰í–ˆì§€ë§Œ ì •ì˜ê°€ ë¶ˆëª…í™•í•¨" |
| ... | ... | ... | ... |
ë¬¸ì œë³„ë¡œ êµ¬ë¶„í•˜ì—¬ í‘œë¥¼ ë‚˜íƒ€ë‚´ì£¼ì„¸ìš”.

ğŸ“Œ ì±„ì  ì§€ì¹¨
1. ë°˜ë“œì‹œ ì±„ì  ê¸°ì¤€ì— ëª…ì‹œëœ í•­ëª©ëª…ê³¼ ë°°ì ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì„¸ìš”. í•­ëª©ì„ ì„ì˜ë¡œ ë°”ê¾¸ê±°ë‚˜ ì¬êµ¬ì„±í•˜ì§€ ë§ˆì„¸ìš”.
2. ê° í•­ëª©ì˜ "ë¶€ì—¬ ì ìˆ˜"ëŠ” í•´ë‹¹ í•­ëª© ë°°ì  ì´ë‚´ì—ì„œ í•™ìƒ ë‹µì•ˆì„ ê¸°ì¤€ìœ¼ë¡œ ì •í™•íˆ ê²°ì •í•˜ì„¸ìš”.
3. "í‰ê°€ ê·¼ê±°"ëŠ” ë°˜ë“œì‹œ í•™ìƒ ë‹µì•ˆì—ì„œ í™•ì¸ ê°€ëŠ¥í•œ ë‚´ìš©ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”. ì¶”ìƒì  í‘œí˜„(ì˜ˆ: 'ì˜í•¨', 'í›Œë¥­í•¨')ì€ ê¸ˆì§€ì…ë‹ˆë‹¤.
4. ëª¨ë“  ì¶œë ¥ì€ **í•œê¸€ë¡œë§Œ** ì‘ì„±í•˜ê³ , ì˜ì–´ëŠ” ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.
5. ëª…í™•í•˜ê²Œ ì±„ì  ê¸°ì¤€ì— ë”°ë¥¸ ë‚´ìš©ì´ ëª¨ë‘ í¬í•¨ëœ ê²½ìš°ì—ë§Œ **ë§Œì (1~2ì )**ì„ ë¶€ì—¬í•˜ì„¸ìš”.
6. ë‹¨ì–´ë§Œ ì–¸ê¸‰í•˜ê±°ë‚˜ ì˜ë¯¸ê°€ ë¶ˆëª…í™•í•œ ê²½ìš°ëŠ” **0ì  ë˜ëŠ” ë¶€ë¶„ì ìˆ˜(0.5ì  ì´í•˜)**ë¥¼ ë¶€ì—¬í•˜ì„¸ìš”.
7. ë¶ˆì™„ì „í•˜ê±°ë‚˜ ë¹„ë…¼ë¦¬ì ì¸ ì„¤ëª…ì€ ë°˜ë“œì‹œ ê°ì  ëŒ€ìƒì…ë‹ˆë‹¤.
8. ê° í•­ëª©ì— ëŒ€í•´ "êµ¬ì²´ì ì¸ ë‚´ìš© í™•ì¸"ì´ ì—†ìœ¼ë©´ ì ìˆ˜ë¥¼ ì£¼ì§€ ë§ˆì„¸ìš”.
9. ì „ì²´ ì ìˆ˜ëŠ” ë¬¸ì œë³„ ë°°ì ì„ ì ˆëŒ€ ì´ˆê³¼í•˜ë©´ ì•ˆ ë©ë‹ˆë‹¤.
10. í‘œ ì•„ë˜ì— ë‹¤ìŒ ë¬¸ì¥ì„ ì‘ì„±í•˜ì„¸ìš”:
   **ì´ì : XXì **

"""
            # 7) GPT í˜¸ì¶œ
            with st.spinner("GPTê°€ ì±„ì  ì¤‘ì…ë‹ˆë‹¤..."):
                result = grade_answer(prompt)

            # 8) ì—ëŸ¬ ì²˜ë¦¬
            if not isinstance(result, str) or result.startswith("[ì˜¤ë¥˜]"):
                st.error(f"GPT ì‘ë‹µ ì˜¤ë¥˜:\n{result}")
                return

            # 9) ì„¸ì…˜ì— ê²°ê³¼ ì €ì¥ ë° í‘œì‹œ ì¤€ë¹„
            st.session_state.last_grading_result = result
            st.session_state.last_selected_student = {"name": name, "id": sid}
            st.session_state.student_answers_data = [{
                "name": name,
                "id": sid,
                "text": text,
                "filename": safe_name
            }]
            st.success("âœ… ì±„ì  ì™„ë£Œ")

    else:
        st.warning("STEP 1ì—ì„œ ë¬¸ì œë¥¼ ë¨¼ì € ì—…ë¡œë“œí•´ì•¼ í•©ë‹ˆë‹¤.")

    # 10) ì´ì „ ì±„ì  ê²°ê³¼ê°€ ìˆìœ¼ë©´ í™”ë©´ì— ì¶œë ¥
    if st.session_state.get("last_grading_result"):
        stu = st.session_state.last_selected_student
        st.markdown(f"### ğŸ“‹ ì±„ì  ê²°ê³¼ - {stu['name']} ({stu['id']})")
        st.markdown(st.session_state.last_grading_result)
